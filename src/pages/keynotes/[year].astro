---
import MainLayout from '@/layouts/MainLayout.astro'
import { getCollection, getEntry } from 'astro:content'
import { ProjectCard } from '@/components/ProjectCard'
import { VideoPlayer } from '@/components/VideoPlayer'

export async function getStaticPaths() {
  const keynotes = await getCollection('keynotes')

  return keynotes.map((k) => ({
    params: { year: k.data.year.toString() },
    props: { keynote: k.data },
  }))
}

const { keynote } = Astro.props

// Get all projects and filter for thesis projects from the keynote's students
const allProjects = await getCollection('projects')
const relatedProjects = allProjects
  .map((p) => p.data)
  .filter(
    (project) =>
      project.category.includes('Thesis') &&
      project.author.some((author) => keynote.students?.includes(author))
  )
  .sort((a, b) => (b.year || 0) - (a.year || 0))
---

<MainLayout>
  <div class="container mx-auto">
    <div class="mb-8">
      <a href="/keynotes" class="inline-flex items-center rounded-full h-10 px-3 bg-neutral-100 text-neutral-800 font-medium">
        ‚Üê Keynotes
      </a>
    </div>

    <div class="grid gap-8">
      <article>
        <div class="flex justify-between items-start mb-4">
          <div>
            <h2 class="text-3xl mb-2 font-neue-display-random">
              {keynote.title}
            </h2>
            <p class="text-neutral-600">{keynote.department}</p>
            {keynote.date ? (
              <div>
                <time class="text-neutral-600">
                  {new Date(keynote.date).toLocaleDateString(
                    undefined,
                    {
                      dateStyle: 'full',
                    }
                  )}
                </time>
                {keynote.time && (
                  <span class="text-neutral-600">
                    at {keynote.time}
                  </span>
                )}
              </div>
            ) : null}
          </div>
        </div>

        <p class="text-neutral-700 mb-4">{keynote.description}</p>

        {
          keynote.location && (
            <p class="text-neutral-600 mb-4">
              <span class="font-medium">Location:</span> {keynote.location}
            </p>
          )
        }

        {
          keynote.video_embed_html && (
            <div class="mt-4 w-full">
              <div
                set:html={keynote.video_embed_html}
                class="[&_iframe]:w-full [&_iframe]:h-full aspect-video"
              />
            </div>
          )
        }

        {
          keynote.students && keynote.students.length > 0 && (
            <div class="py-10">
              <div class="text-neutral-700 font-medium pb-2">Students</div>
              <ul class="text-neutral-600 flex flex-wrap gap-x-6 gap-y-3">
                {keynote.students.map((student) => (
                  <li>{student}</li>
                ))}
              </ul>
            </div>
          )
        }

        {
          keynote.url && (
            <a
              href={keynote.url}
              target="_blank"
              rel="noopener noreferrer"
              class="text-blue-600 hover:text-blue-800 inline-block mb-4"
            >
              Event Link
            </a>
          )
        }
      </article>

      {
        relatedProjects.length > 0 && (
          <section class="mt-12">
            <h3 class="text-2xl font-semibold mb-6">Projects</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-x-6 gap-y-8">
              {relatedProjects.map((project) => (
                <ProjectCard client:load project={project} />
              ))}
            </div>
          </section>
        )
      }
    </div>
  </div>
</MainLayout>
